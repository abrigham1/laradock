version: '3'

networks:
  frontend:
    driver: ${NETWORKS_DRIVER}
  backend:
    driver: ${NETWORKS_DRIVER}
services:

### Workspace Utilities ##################################
  workspace:
    image: 620139381534.dkr.ecr.us-east-1.amazonaws.com/abrigham/workspace:latest
    extra_hosts:
      - "dockerhost:${DOCKER_HOST_IP}"
    ports:
      - "${WORKSPACE_SSH_PORT}:22"
    tty: true
    environment:
      - PHP_IDE_CONFIG=${PHP_IDE_CONFIG}
      - DOCKER_HOST=tcp://docker-in-docker:2375
    networks:
      - frontend
      - backend
    links:
      - docker-in-docker

### PHP-FPM ##############################################
  php-fpm:
    image: 620139381534.dkr.ecr.us-east-1.amazonaws.com/abrigham/php-fpm:latest
    expose:
      - "9000"
    extra_hosts:
      - "dockerhost:${DOCKER_HOST_IP}"
    environment:
      - PHP_IDE_CONFIG=${PHP_IDE_CONFIG}
      - DOCKER_HOST=tcp://docker-in-docker:2375
      - FAKETIME=${PHP_FPM_FAKETIME}
    depends_on:
      - workspace
    networks:
      - backend
    links:
      - docker-in-docker

### NGINX Server #########################################
  nginx:
    image: 620139381534.dkr.ecr.us-east-1.amazonaws.com/abrigham/nginx:latest
    ports:
      - "${NGINX_HOST_HTTP_PORT}:80"
      - "${NGINX_HOST_HTTPS_PORT}:443"
    depends_on:
      - php-fpm
      - anaconda
    networks:
      - frontend
      - backend

### Docker-in-Docker ################################################
  docker-in-docker:
    image: 620139381534.dkr.ecr.us-east-1.amazonaws.com/abrigham/docker-in-docker:latest
    privileged: true
    expose:
      - 2375
    networks:
      - backend

### ANACONDA ################################################
  anaconda:
    image: 620139381534.dkr.ecr.us-east-1.amazonaws.com/abrigham/anaconda:latest
    expose:
      - "5000"
    extra_hosts:
      - "dockerhost:${DOCKER_HOST_IP}"
    tty: true
    networks:
      - frontend
      - backend
